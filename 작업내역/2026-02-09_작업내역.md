# 작업내역 - 2026-02-09

## 1. QNA 게시판 대규모 리디자인 - 사용자/관리자 분리

### 개요
기존 단일 뷰 Q&A 게시판을 역할(role) 기반으로 사용자/관리자 화면을 완전 분리하고,
자동 답변 시스템, 텔레그램 알림, 카테고리 시스템, 회원 관리 기능을 추가.

---

## 2. 데이터베이스 스키마 변경

### users 테이블
- `role ENUM('admin','user') NOT NULL DEFAULT 'user'` 추가
- `site VARCHAR(50) DEFAULT NULL` 추가

### posts 테이블
- `category ENUM('긴급','오류','건의','추가개발','기타') NOT NULL DEFAULT '기타'` 추가
- `user_id INT DEFAULT NULL` 추가 (users FK)
- `author_name` NOT NULL → NULL 허용으로 변경 (user_id FK 사용)

### 초기 데이터
- admin / admin1234 (관리자)
- man / 12341234 (맨하탄 사용자)
- ganzi / 12341234 (간지 사용자)

---

## 3. 백엔드 API 변경

### api/config.php
- `sendTelegramNotification($message)` 함수 추가
- `getRandomAdminName()` 함수 추가 - 12명 랜덤 이름 풀
- `requireAuth()` 함수 추가 - 세션 기반 인증 체크
- `requireAdmin()` 함수 추가 - 관리자 권한 체크
- TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID 상수 추가

### api/login.php
- SELECT에 role, site 필드 포함
- 세션에 role, site 저장
- GET 응답에 role, site 포함

### api/posts.php
- GET: users 테이블 LEFT JOIN으로 user_display_name, user_site 조회
- GET: category 필터 추가
- POST: requireAuth() 인증 필수, user_id 세션에서 가져옴
- POST: category 필드 필수, 유효성 검사
- POST: 자동 댓글 생성 (getRandomAdminName() + 고정 메시지)
- POST: 텔레그램 알림 전송 (사이트명 포함)
- PUT: 관리자 전용 상태 변경 기능 추가
- DELETE: requireAdmin() 관리자만 삭제 가능

### api/comments.php
- POST: requireAdmin() 관리자만 댓글 작성 가능
- POST: 댓글 작성 시 게시글 status를 'answered'로 자동 변경
- DELETE: requireAdmin() 관리자만 삭제 가능

### api/admin/users.php (신규)
- GET: 전체 회원 목록 조회 (관리자 전용)
- POST: 새 회원 생성 (password_hash, 중복 체크)
- PUT: 회원 정보 수정 (비밀번호 선택적 변경)
- DELETE: 회원 삭제 (자기 자신 삭제 방지)

### api/setup.php (신규)
- DB 스키마 마이그레이션 스크립트
- 초기 사용자 계정 생성

---

## 4. 프론트엔드 변경

### frontend/src/App.tsx (재작성)
- 기존 960줄 → ~140줄로 축소
- 역할 기반 라우팅: admin → AdminApp, user → UserApp
- 로그인 화면 (세션 체크 → 로그인 폼 → role 분기)

### frontend/src/UserApp.tsx (신규)
- 사용자 전용 뷰: 목록 / 상세 / 작성
- 작성 시 카테고리 선택 필수
- 작성자 필드 제거 (로그인 사용자 자동 사용)
- 수정/삭제/댓글 작성 기능 없음

### frontend/src/AdminApp.tsx (신규)
- 관리자 대시보드: 게시판 관리 / 회원 관리 탭
- 게시판 관리: 목록(검색/필터) → 상세(답변/삭제/상태변경)
- 카테고리/상태 필터, 검색
- 관리자 답변 작성, 댓글 삭제
- 상태 변경 (대기/답변완료/종료)
- 회원 관리: 목록 → 추가/수정/삭제 다이얼로그

### frontend/src/lib/api.ts
- User 인터페이스: role, site 추가
- Post 인터페이스: user_id, category, user_display_name, user_site 추가
- postsApi.update 제거
- adminApi 추가 (users CRUD)

---

## 5. Nginx 설정 변경

### /etc/nginx/sites-available/qna-board
- `/api/admin/` 경로 PHP-FPM 라우팅 추가
- admin API가 `/home/qna-board/api/admin/` 디렉토리로 매핑

---

## 6. 서버 배포 (172.235.193.234)

- PHP 8.4 + MySQL 8.4 + Nginx 1.28 환경
- SSH 키 기반 접속 설정
- API 파일 전체 업로드
- 프론트엔드 빌드 후 dist 업로드
- DB 스키마 마이그레이션 (ALTER TABLE)
- 초기 사용자 계정 생성 (setup.php)
- Nginx 설정 업데이트 및 리로드

---

## 7. 테스트 결과 (2026-02-09 04:06 UTC)

| 기능 | 결과 |
|------|------|
| 프론트엔드 페이지 로드 | ✅ 200 OK |
| 사용자 로그인 (man) | ✅ role=user, site=맨하탄 |
| 사용자 로그인 (ganzi) | ✅ role=user, site=간지 |
| 관리자 로그인 (admin) | ✅ role=admin |
| 세션 유지 (GET login.php) | ✅ logged_in=true |
| 사용자 글 작성 + 카테고리 | ✅ post_id 생성 |
| 자동 댓글 (랜덤 이름) | ✅ 마이클/나탸샤 등 |
| 관리자 댓글 작성 | ✅ comment_id 생성 |
| 관리자 상태 변경 (PUT) | ✅ answered |
| 관리자 유저 목록 조회 | ✅ 3명 |
| 텔레그램 알림 | ⏳ 토큰 미설정 |

---

## 8. 변경된 파일 목록

| 파일 | 변경 내용 |
|------|-----------|
| `database.sql` | 스키마 업데이트 (role, site, category, user_id) |
| `api/config.php` | 텔레그램, 랜덤이름, 인증 헬퍼 함수 추가 |
| `api/login.php` | role, site 포함 세션/응답 |
| `api/posts.php` | users JOIN, category, 자동댓글, 텔레그램, PUT 상태변경 |
| `api/comments.php` | 관리자 전용 댓글, 자동 상태 변경 |
| `api/admin/users.php` | 회원 관리 CRUD (신규) |
| `api/setup.php` | DB 마이그레이션 + 초기 데이터 (신규) |
| `frontend/src/App.tsx` | 역할 기반 라우팅으로 재작성 |
| `frontend/src/UserApp.tsx` | 사용자 전용 뷰 (신규) |
| `frontend/src/AdminApp.tsx` | 관리자 대시보드 (신규) |
| `frontend/src/lib/api.ts` | 타입/API 업데이트, adminApi 추가 |

---

## 9. 계정 정보

| 아이디 | 비밀번호 | 역할 | 사이트 |
|--------|----------|------|--------|
| admin | admin1234 | 관리자 | - |
| man | 12341234 | 유저 | 맨하탄 |
| ganzi | 12341234 | 유저 | 간지 |
