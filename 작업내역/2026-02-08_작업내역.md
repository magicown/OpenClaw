# 작업내역 - 2026-02-08

## 1. Q&A 게시판 백엔드 버그 수정

### api/posts.php (line 160)
- **문제**: AI 자동답변 INSERT 시 `is_ai_answer` 파라미터 누락 → `SQLSTATE[HY093]: Invalid parameter number`
- **수정**: `$stmt->execute([$postId, $aiAnswer])` → `$stmt->execute([$postId, $aiAnswer, true])`

### api/ai-answer.php (line 59)
- **문제**: 동일한 `is_ai_answer` 파라미터 누락
- **수정**: `$stmt->execute([$postId, $aiAnswer])` → `$stmt->execute([$postId, $aiAnswer, true])`

### api/comments.php (line 42)
- **문제**: PHP `false`가 PDO를 통해 MySQL boolean 컬럼에 빈 문자열로 전달됨 → `Incorrect integer value: ''`
- **수정**: `$data['is_ai_answer'] ?? false` → `(int)($data['is_ai_answer'] ?? false)`

---

## 2. 프론트엔드 전면 재구축 (frontend/src/App.tsx)

기존: 게시글 목록만 표시
변경: 전체 CRUD + 댓글 + AI 답변 + 파일 첨부 기능 추가

- 게시글 생성/수정/삭제 기능
- 게시글 상세보기
- 댓글 생성/삭제
- AI 답변 요청 버튼
- 파일 첨부 업로드
- shadcn/ui 컴포넌트 활용 (Dialog, Textarea, Label 등)

---

## 3. AI 모델 Gemini 연동

### api/config.php
- 더미 AI 응답 → Google Gemini API 실제 연동
- API 키: `AIzaSyCtNxMa6WGwtko9f5TEk5fYXLzN8vac0vg`
- 모델: `gemini-2.0-flash`
- `generateAIAnswer()` 함수 구현 (curl → Gemini REST API)

---

## 4. OpenClaw AI 모델 변경 (GLM → Gemini)

### /root/.openclaw/openclaw.json
- 기존: `zai/glm-4.7` (ZhipuAI GLM 모델)
- 변경: `google/gemini-2.0-flash` → 최종 `google/gemini-2.5-flash`
- 커스텀 provider 삭제, 빌트인 `google` provider 사용

### /root/.openclaw/agents/main/agent/models.json
- 커스텀 provider 설정 제거 → `{"providers": {}}`

### systemd 서비스 환경변수 추가
- `/root/.config/systemd/user/openclaw-gateway.service` → `GEMINI_API_KEY` 추가
- `/root/.config/systemd/user/openclaw-node.service` → `GEMINI_API_KEY` 추가
- `/root/.bashrc` → `export GEMINI_API_KEY` 추가

---

## 5. 텔레그램 봇 Gemini 연동 확인

- 봇: `@OpenClawAi20260208_bot`
- polling 모드 정상 동작
- `provider=google model=gemini-2.5-flash messageChannel=telegram` 확인

---

## 6. Gemini 텔레그램 도구 실행 문제 진단 및 수정

### 문제 1: Gemini API 속도 제한 (RESOURCE_EXHAUSTED)
- **원인**: `gemini-2.0-flash` 무료 플랜 5 RPM 제한
- **해결**: `gemini-2.5-flash`로 업그레이드 (유료 플랜이므로 속도 제한 충분)

### 문제 2: exec 도구 파라미터 타입 혼동
- **원인**: TOOLS.md에 `system.run`(배열)과 `exec`(문자열) 설명 혼재 → Gemini가 command를 배열로 전달
- **에러**: `Validation failed for tool "exec": command: must be string`
- **해결**: TOOLS.md 전면 개정 - command는 반드시 문자열이라고 명확히 강조

### 문제 3: Claude Code root 권한 문제
- **원인**: root에서 `--dangerously-skip-permissions` 사용 불가
- **에러**: `--dangerously-skip-permissions cannot be used with root/sudo privileges`
- **해결**:
  - `claude-runner` 사용자 생성
  - Claude Code를 `/usr/local/bin/claude`에 복사 설치
  - TOOLS.md에 `/usr/sbin/runuser -u claude-runner` 사용법 명시

### 문제 4: runuser 경로 문제
- **원인**: OpenClaw exec 환경에서 `/usr/sbin`이 PATH에 없음
- **에러**: `runuser: command not found`
- **해결**: TOOLS.md에서 전체 경로 `/usr/sbin/runuser` 사용하도록 수정

### 문제 5: Claude Code workdir 권한 문제
- **원인**: `claude-runner`가 `/root/.openclaw/workspace`에 접근 불가
- **에러**: `EACCES: permission denied`
- **해결**: TOOLS.md에서 workdir를 `/home/qna-board`로 변경

### 문제 6: 따옴표 이스케이프 에러
- **원인**: Gemini가 프롬프트 안에 작은따옴표를 잘못 이스케이프
- **에러**: `bash: unexpected EOF while looking for matching '''`
- **해결**: TOOLS.md에 따옴표 이스케이프 가이드 추가 (작은따옴표 대신 큰따옴표 사용)

### 문제 7: PTY 미설정으로 Claude Code 출력 없음
- **원인**: `pty: true` 미설정 시 Claude Code 출력이 버퍼링되어 표시 안 됨
- **해결**: TOOLS.md에 Claude Code 실행 시 반드시 `pty: true` 설정 명시

---

## 7. 변경된 파일 목록

| 파일 | 변경 내용 |
|------|-----------|
| `/home/qna-board/api/config.php` | Gemini API 연동, generateAIAnswer() 구현 |
| `/home/qna-board/api/posts.php` | is_ai_answer 파라미터 누락 수정 |
| `/home/qna-board/api/ai-answer.php` | is_ai_answer 파라미터 누락 수정, Gemini 연동 |
| `/home/qna-board/api/comments.php` | boolean 타입 캐스팅 수정 |
| `/home/qna-board/frontend/src/App.tsx` | 전체 CRUD/댓글/AI답변/파일첨부 UI 구현 |
| `/root/.openclaw/openclaw.json` | 모델 변경 (GLM → gemini-2.5-flash) |
| `/root/.openclaw/agents/main/agent/models.json` | 커스텀 provider 제거 |
| `/root/.openclaw/workspace/TOOLS.md` | exec 가이드 전면 개정, Claude Code 위임 수정 |
| `/root/.config/systemd/user/openclaw-gateway.service` | GEMINI_API_KEY 환경변수 추가 |
| `/root/.config/systemd/user/openclaw-node.service` | GEMINI_API_KEY 환경변수 추가 |
| `/root/.bashrc` | GEMINI_API_KEY export 추가 |
| `/usr/local/bin/claude` | Claude Code 공유 경로에 설치 |
| `/usr/local/bin/sync-claude-credentials.sh` | 인증 동기화 스크립트 (신규) |
| crontab | 5분마다 인증 동기화 크론잡 추가 |

---

## 8. 최종 테스트 결과 (2026-02-08 16:38 UTC)

| 테스트 | 결과 |
|--------|------|
| 명령어 실행 (디스크/메모리 확인) | 성공 |
| 파일 읽기 (posts.php) | 성공 |
| 서비스 관리 (nginx 상태) | 성공 |
| Claude Code 위임 (파일 작성) | 성공 |
| 텔레그램 전송 | 성공 |

- 도구 호출 5회, 성공 5회, 에러 0회
